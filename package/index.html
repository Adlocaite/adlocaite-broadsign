<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Adlocaite Broadsign Integration</title>
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Main player container -->
  <div id="adlocaite-container" class="adlocaite-container">
    <div class="loading-screen">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading Adlocaite...</div>
    </div>
  </div>

  <!-- Debug panel (only visible in debug mode) -->
  <div id="debug-panel" class="debug-panel" style="display: none;">
    <h3>Adlocaite Debug Panel</h3>
    <div id="debug-log" class="debug-log"></div>
  </div>

  <!-- Configuration -->
  <script src="js/config.js"></script>

  <!-- Core modules -->
  <script src="js/adlocaite-api.js"></script>
  <script src="js/broadsign-adapter.js"></script>
  <script src="js/vast-parser.js"></script>
  <script src="js/player.js"></script>
  <script src="js/cache-manager.js"></script>

  <!-- Main application -->
  <script>
    /**
     * Adlocaite Broadsign Integration
     * Main application orchestrator
     */
    class AdlocaiteApp {
      constructor() {
        this.config = null;
        this.apiClient = null;
        this.broadsignAdapter = null;
        this.vastParser = null;
        this.player = null;
        this.cacheManager = null;
        this.initialized = false;
        this.initializing = false;
        this.initPromise = null;
      }

      /**
       * Initialize application
       * Prevents parallel initialization calls with a lock mechanism
       */
      async initialize() {
        // If already initialized, return immediately
        if (this.initialized) {
          console.log('[Adlocaite] Already initialized, skipping');
          return;
        }

        // If currently initializing, wait for existing initialization to complete
        if (this.initializing) {
          console.log('[Adlocaite] Initialization already in progress, waiting...');
          return this.initPromise;
        }

        // Set lock and create promise
        this.initializing = true;
        this.initPromise = this._performInitialization();

        try {
          await this.initPromise;
        } finally {
          this.initializing = false;
        }
      }

      /**
       * Internal initialization logic
       */
      async _performInitialization() {
        console.log('[Adlocaite] Initializing application...');

        try {
          // Load configuration
          this.config = window.ADLOCAITE_CONFIG;
          if (!this.config) {
            throw new Error('Configuration not found. Please create config.js from config.example.js');
          }

          // Enable debug panel if needed
          if (this.config.debugMode) {
            document.getElementById('debug-panel').style.display = 'block';
            this.setupDebugLogging();
          }

          // Validate API key
          if (!this.config.apiKey || this.config.apiKey === 'pub_xxxx') {
            throw new Error('Invalid API key. Please configure your API key in config.js');
          }

          // Comprehensive config validation
          if (!this.config.apiBaseUrl || !this.config.apiBaseUrl.startsWith('http')) {
            throw new Error('Invalid apiBaseUrl in config. Must be a valid HTTP(S) URL.');
          }

          if (typeof this.config.requestTimeout !== 'number' || this.config.requestTimeout <= 0) {
            throw new Error('Invalid requestTimeout in config. Must be a positive number.');
          }

          if (typeof this.config.assetTimeout !== 'number' || this.config.assetTimeout <= 0) {
            throw new Error('Invalid assetTimeout in config. Must be a positive number.');
          }

          if (typeof this.config.minBidCents !== 'number' || this.config.minBidCents < 0) {
            throw new Error('Invalid minBidCents in config. Must be a non-negative number.');
          }

          if (typeof this.config.maxRetries !== 'number' || this.config.maxRetries < 0) {
            throw new Error('Invalid maxRetries in config. Must be a non-negative number.');
          }

          if (typeof this.config.cachingInterval !== 'number' || this.config.cachingInterval <= 0) {
            throw new Error('Invalid cachingInterval in config. Must be a positive number.');
          }

          // Initialize components
          this.apiClient = new AdlocaiteAPIClient(this.config);
          this.broadsignAdapter = new BroadsignAdapter(this.config);
          this.vastParser = new VASTParser(this.config);
          this.player = new AdlocaitePlayer(
            this.config,
            this.apiClient,
            this.broadsignAdapter,
            this.vastParser
          );
          this.cacheManager = new CacheManager(this.config, this.apiClient);

          // Initialize Broadsign adapter
          const playerInfo = this.broadsignAdapter.initialize();
          console.log('[Adlocaite] Player info:', playerInfo);

          // Initialize player
          this.player.initialize('adlocaite-container');

          this.initialized = true;
          console.log('[Adlocaite] Application initialized successfully');

        } catch (err) {
          console.error('[Adlocaite] Initialization failed:', err);
          this.showError('Initialization failed: ' + err.message);
          throw err;
        }
      }

      /**
       * Start playback - called when BroadSignPlay() is triggered
       */
      async start() {
        if (!this.initialized) {
          console.error('[Adlocaite] Cannot start - not initialized');
          return;
        }

        console.log('[Adlocaite] Starting playback...');

        try {
          // Get screen ID
          const screenId = this.broadsignAdapter.getScreenId();

          // Fail if no screen ID available
          if (!screenId) {
            throw new Error('No screen ID available. Package must run in Broadsign Player or provide screen_id via URL parameter.');
          }

          console.log('[Adlocaite] Screen ID:', screenId);

          // Start cache manager
          if (this.config.enableCaching) {
            this.cacheManager.start(screenId);
          }

          // Request offer using external ID (frame_id from Broadsign)
          console.log('[Adlocaite] Requesting offer...');
          const offerResponse = await this.apiClient.requestOfferByExternalId(screenId, {
            vast: this.config.vastMode,
            minBidCents: this.config.minBidCents
          });

          // Check for no offers available (404 handled gracefully)
          if (offerResponse && offerResponse.noOffersAvailable) {
            console.log('[Adlocaite] No offers available for this screen');
            throw new Error('No offers available');
          }

          // Check for other API errors
          if (offerResponse && offerResponse.error) {
            console.error('[Adlocaite] API error:', offerResponse.message);
            throw new Error(offerResponse.message || 'API request failed');
          }

          // Check if VAST XML (string) or JSON
          let vastXml, offerData;

          if (typeof offerResponse === 'string') {
            // VAST XML response
            vastXml = offerResponse;
            console.log('[Adlocaite] VAST XML received');
          } else {
            // JSON response with VAST XML
            vastXml = offerResponse.vast; // API returns "vast", not "vast_xml"
            offerData = offerResponse;
            console.log('[Adlocaite] Offer received:', offerData);
          }

          if (!vastXml) {
            throw new Error('No VAST XML in response');
          }

          // Parse VAST with specific error handling
          let vastData;
          try {
            vastData = this.vastParser.parse(vastXml);
            console.log('[Adlocaite] VAST parsed:', vastData);
          } catch (parseErr) {
            console.error('[Adlocaite] VAST parsing failed:', parseErr);
            console.error('[Adlocaite] VAST XML:', vastXml.substring(0, 500));
            throw new Error('Invalid VAST XML: ' + parseErr.message);
          }

          // Extract deal ID from VAST extensions
          let dealId = this.vastParser.getDealId();
          
          // Fallback: Accept offer to get deal ID if not in VAST
          if (!dealId && offerData && offerData.offer_id) {
            console.log('[Adlocaite] Accepting offer:', offerData.offer_id);

            try {
              const acceptResponse = await this.apiClient.acceptOffer(
                offerData.offer_id,
                offerData.bid_price_cents
              );

              if (!acceptResponse || !acceptResponse.deal_id) {
                throw new Error('Accept response missing deal_id');
              }

              dealId = acceptResponse.deal_id;
              console.log('[Adlocaite] Offer accepted. Deal ID:', dealId);
            } catch (acceptErr) {
              console.error('[Adlocaite] Failed to accept offer:', acceptErr);
              throw new Error('Offer acceptance failed: ' + acceptErr.message);
            }
          }

          // Play media
          console.log('[Adlocaite] Starting playback...');
          await this.player.playFromVAST(vastData, dealId);
          console.log('[Adlocaite] Playback completed successfully');

        } catch (err) {
          console.error('[Adlocaite] Playback failed:', err);
          
          // Show fallback if enabled
          if (this.config.fallbackEnabled) {
            const message = err.message || 'Playback error';
            this.player.showFallback(message);
            
            // Display fallback for a reasonable duration
            setTimeout(() => {
              console.log('[Adlocaite] Fallback display completed');
            }, 15000);
          } else {
            this.showError('Playback failed: ' + err.message);
          }
        }
      }

      /**
       * Show error message
       */
      showError(message) {
        const container = document.getElementById('adlocaite-container');
        container.innerHTML = `
          <div class="error-screen">
            <div class="error-icon">âš </div>
            <div class="error-message">${message}</div>
          </div>
        `;
      }

      /**
       * Setup debug logging to panel
       */
      setupDebugLogging() {
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const debugLog = document.getElementById('debug-log');

        console.log = function(...args) {
          originalConsoleLog.apply(console, args);
          const message = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' ');
          debugLog.innerHTML += `<div class="debug-entry log">${message}</div>`;
          debugLog.scrollTop = debugLog.scrollHeight;
        };

        console.error = function(...args) {
          originalConsoleError.apply(console, args);
          const message = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' ');
          debugLog.innerHTML += `<div class="debug-entry error">${message}</div>`;
          debugLog.scrollTop = debugLog.scrollHeight;
        };
      }
    }

    // Create global app instance
    const app = new AdlocaiteApp();

    // Initialize on page load (non-blocking)
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('[Adlocaite] DOM loaded');

      try {
        await app.initialize();
      } catch (err) {
        console.error('[Adlocaite] Failed to initialize:', err);
      }
    });

    // Handle Broadsign ready event
    // IMPORTANT: BroadSignPlay() can be called BEFORE DOMContentLoaded
    // We must wait for initialization to complete before starting playback
    window.onBroadSignReady = async function() {
      console.log('[Adlocaite] Broadsign ready - starting playback');

      try {
        // Wait for initialization if not complete yet (with timeout)
        if (!app.initialized) {
          console.log('[Adlocaite] Waiting for initialization to complete...');

          // Wrap initialization with a timeout (30 seconds max)
          const initPromise = app.initialize();
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Initialization timeout after 30s')), 30000)
          );

          await Promise.race([initPromise, timeoutPromise]);
        }

        await app.start();
      } catch (err) {
        console.error('[Adlocaite] Start failed:', err);
      }
    };

    // Alternative: Listen for custom event
    window.addEventListener('broadsignready', async () => {
      console.log('[Adlocaite] Broadsign ready event received');

      try {
        // Wait for initialization if not complete yet (with timeout)
        if (!app.initialized) {
          console.log('[Adlocaite] Waiting for initialization to complete...');

          // Wrap initialization with a timeout (30 seconds max)
          const initPromise = app.initialize();
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Initialization timeout after 30s')), 30000)
          );

          await Promise.race([initPromise, timeoutPromise]);
        }

        await app.start();
      } catch (err) {
        console.error('[Adlocaite] Start failed:', err);
      }
    });

    // For testing in browser (not in Broadsign Player)
    // Uncomment the line below to auto-start after 2 seconds
    // setTimeout(() => { if (!app.broadsignAdapter.isBroadsignEnvironment()) app.start(); }, 2000);
  </script>
</body>
</html>


